{% extends "layout.html" %}
{% block content %}
<div class="container" style="max-width: 1000px; margin: 24px auto;">
  <h2 style="margin-bottom: 8px;">Edit Assignment: {{ assignment.title }}</h2>
  <small style="color:#8a92b3;">Subject: {{ assignment.subject }} · Class: {{ assignment.class_ref.class_name }}</small>

  <form method="POST" style="margin-top: 16px;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    {% for q in questions %}
    <div class="question-block" data-qid="{{ q.id }}" style="margin-bottom: 18px; padding: 14px; border:1px solid rgba(118,131,255,0.3); border-radius: 12px; background: rgba(92,107,255,0.08);">
      <input type="hidden" name="q_id" value="{{ q.id }}">
      <label><strong>Question {{ loop.index }} Text</strong></label>
      <textarea name="question_text_{{ q.id }}" rows="3" style="width:100%;">{{ q.question_text }}</textarea>

      <div style="display:flex; gap:8px; margin-top:8px;">
        <div>
          <label>Type</label>
          <select name="question_type_{{ q.id }}" class="question-type">
            <option value="free" {% if q.question_type == 'free' %}selected{% endif %}>Free Response</option>
            <option value="multiple_choice" {% if q.question_type == 'multiple_choice' %}selected{% endif %}>Multiple Choice</option>
          </select>
        </div>
        <div>
          <label>Difficulty</label>
          <select name="difficulty_level_{{ q.id }}">
            <option value="easy" {% if q.difficulty_level == 'easy' %}selected{% endif %}>Easy</option>
            <option value="medium" {% if q.difficulty_level == 'medium' %}selected{% endif %}>Medium</option>
            <option value="hard" {% if q.difficulty_level == 'hard' %}selected{% endif %}>Hard</option>
          </select>
        </div>
      </div>

      <div class="mc-choices" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; margin-top:8px;">
        <div>
          <label>Choice A</label>
          <input type="text" name="choice_a_{{ q.id }}" value="{{ q.choice_a or '' }}">
        </div>
        <div>
          <label>Choice B</label>
          <input type="text" name="choice_b_{{ q.id }}" value="{{ q.choice_b or '' }}">
        </div>
        <div>
          <label>Choice C</label>
          <input type="text" name="choice_c_{{ q.id }}" value="{{ q.choice_c or '' }}">
        </div>
        <div>
          <label>Choice D</label>
          <input type="text" name="choice_d_{{ q.id }}" value="{{ q.choice_d or '' }}">
        </div>
      </div>

      <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; margin-top:8px;">
        <div>
          <label>Correct Answer(s)</label>
          <input type="text" name="correct_answer_{{ q.id }}" value="{{ q.correct_answer or '' }}" placeholder="e.g., A or A,B" class="correct-answer">
        </div>
        <div>
          <label>Explanation</label>
          <input type="text" name="explanation_{{ q.id }}" value="{{ q.explanation or '' }}">
        </div>
      </div>
    </div>
    {% endfor %}

    <button class="btn" type="submit">Save Changes</button>
    <a class="btn" href="/teacher/assignments/{{ assignment.id }}" style="margin-left:8px; background: transparent; border:1px solid rgba(118,131,255,0.4);">Back to Overview</a>
  </form>

  <!-- Generate More Questions -->
  <div style="margin-top: 24px; padding: 16px; border:1px solid rgba(118,131,255,0.3); border-radius: 12px; background: rgba(0,242,255,0.08);">
    <h3 style="margin-bottom: 8px;">Generate More Questions</h3>
    <small style="color:#8a92b3;">Add AI-generated questions to this assignment using the same settings.</small>

    <div style="display: flex; gap: 8px; margin-top: 12px; align-items: flex-end;">
      <div>
        <label style="font-size: 0.85rem;">Number of Questions</label>
        <input type="number" id="moreQuestionsCount" value="5" min="1" max="20" style="width: 100px;">
      </div>
      <button class="btn" type="button" onclick="generateMoreQuestions()">Generate & Add</button>
    </div>

    <div id="moreQuestionsResult" style="margin-top: 12px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; font-size: 0.85rem; color: var(--muted); display: none;"></div>
  </div>
</div>

<script>
async function generateMoreQuestions() {
  const resultDiv = document.getElementById('moreQuestionsResult');
  resultDiv.style.display = 'block';
  resultDiv.textContent = 'Generating additional questions...';

  const numQuestions = parseInt(document.getElementById('moreQuestionsCount').value || '5', 10);

  const payload = {
    practice_id: {{ assignment.id }},
    num_questions: numQuestions
  };

  try {
    const res = await fetch('/teacher/assignments/{{ assignment.id }}/generate_more', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    
    if (res.ok) {
      resultDiv.innerHTML = `<strong style="color: var(--success);">✓ Success!</strong> Added ${data.questions_added} questions. Reloading...`;
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    } else {
      resultDiv.innerHTML = `<strong style="color: var(--warning);">✗ Error:</strong> ${data.error || 'Unknown error'}`;
    }
  } catch (err) {
    resultDiv.innerHTML = `<strong style="color: var(--warning);">✗ Network Error:</strong> ${err.message}`;
  }
}
</script>
<script>
// Toggle multiple-choice fields and validate MC answers
document.querySelectorAll('.question-block').forEach(block => {
  const typeSelect = block.querySelector('.question-type');
  const mcChoices = block.querySelector('.mc-choices');
  const correctInput = block.querySelector('.correct-answer');

  function updateVisibility() {
    const isMC = typeSelect && typeSelect.value === 'multiple_choice';
    if (mcChoices) mcChoices.style.display = isMC ? 'grid' : 'none';
    if (correctInput) correctInput.placeholder = isMC ? 'e.g., A or A,B' : 'e.g., 42 or "Momentum increases"';
  }
  if (typeSelect) {
    typeSelect.addEventListener('change', updateVisibility);
    updateVisibility();
  }
});

document.querySelector('form').addEventListener('submit', function(e) {
  let ok = true;
  document.querySelectorAll('.question-block').forEach(block => {
    const typeSelect = block.querySelector('.question-type');
    const correctInput = block.querySelector('.correct-answer');
    if (typeSelect && typeSelect.value === 'multiple_choice' && correctInput) {
      const val = (correctInput.value || '').trim();
      if (val && !/^([A-D])(,([A-D]))*$/.test(val.toUpperCase())) {
        ok = false;
        correctInput.style.border = '1px solid #ff9f1c';
      } else {
        correctInput.style.border = '';
      }
    }
  });
  if (!ok) {
    e.preventDefault();
    alert('For Multiple Choice, use letters A-D (e.g., A or A,B).');
  }
});
</script>
{% endblock %}