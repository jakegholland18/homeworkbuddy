{% extends "layout.html" %}
{% block content %}

<style>
    .game-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 40px 20px;
        text-align: center;
    }

    .game-header {
        margin-bottom: 40px;
    }

    .game-title {
        font-size: 2.5rem;
        font-weight: 900;
        background: linear-gradient(135deg, #ff6fd8, #00f2ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
    }

    .game-timer {
        font-size: 3rem;
        font-weight: 900;
        color: #00f2ff;
        margin: 20px 0;
        font-family: 'Courier New', monospace;
    }

    .game-progress {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
    }

    .progress-stat {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 700;
    }

    .question-card {
        background: var(--glass-1);
        border: 2px solid var(--border-soft);
        border-radius: 16px;
        padding: 40px;
        margin-bottom: 30px;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .question-text {
        font-size: 2.2rem;
        font-weight: 800;
        color: var(--text);
        margin-bottom: 30px;
    }

    .answer-input {
        font-size: 1.8rem;
        padding: 15px 25px;
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid var(--border-soft);
        border-radius: 12px;
        color: var(--text);
        text-align: center;
        width: 300px;
        margin: 0 auto;
        font-weight: 700;
    }

    .answer-input:focus {
        outline: none;
        border-color: #00f2ff;
        box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
    }

    .options-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        max-width: 600px;
        margin: 0 auto;
    }

    .option-btn {
        padding: 20px;
        background: linear-gradient(135deg, rgba(92, 107, 255, 0.2), rgba(0, 242, 255, 0.1));
        border: 2px solid rgba(92, 107, 255, 0.4);
        border-radius: 12px;
        color: var(--text);
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .option-btn:hover {
        transform: translateY(-5px) scale(1.05);
        border-color: #00f2ff;
        box-shadow: 0 8px 25px rgba(0, 242, 255, 0.3);
    }

    .option-btn.correct {
        background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(76, 175, 80, 0.2));
        border-color: #4caf50;
        animation: correctPulse 0.5s ease;
    }

    .option-btn.incorrect {
        background: linear-gradient(135deg, rgba(255, 107, 107, 0.3), rgba(255, 77, 77, 0.2));
        border-color: #ff6b6b;
        animation: incorrectShake 0.5s ease;
    }

    @keyframes correctPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    @keyframes incorrectShake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
    }

    .submit-btn {
        padding: 15px 40px;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        border: none;
        border-radius: 12px;
        color: var(--text);
        font-size: 1.2rem;
        font-weight: 800;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
    }

    .submit-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(92, 107, 255, 0.4);
    }

    .results-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }

    .results-modal.show {
        display: flex;
    }

    .results-content {
        background: linear-gradient(135deg, rgba(10, 14, 39, 0.95), rgba(5, 8, 19, 0.98));
        border: 3px solid #00f2ff;
        border-radius: 24px;
        padding: 50px;
        max-width: 600px;
        text-align: center;
        animation: resultsAppear 0.5s ease;
    }

    @keyframes resultsAppear {
        from {
            opacity: 0;
            transform: scale(0.8) translateY(50px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .results-title {
        font-size: 3rem;
        font-weight: 900;
        margin-bottom: 20px;
    }

    .results-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }

    .result-stat {
        background: rgba(0, 0, 0, 0.4);
        padding: 20px;
        border-radius: 12px;
    }

    .result-stat-label {
        font-size: 0.9rem;
        color: var(--muted-2);
        margin-bottom: 8px;
    }

    .result-stat-value {
        font-size: 2.5rem;
        font-weight: 900;
        background: linear-gradient(135deg, #ffdd55, #ff6fd8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
.loader {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 4px solid #00f2ff;
    border-radius: 50%;
    border-top: 4px solid #ff6fd8;
    animation: spin 0.8s linear infinite;
    margin-bottom: 10px;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<div class="game-container fade-in">
    
    <div class="game-header">
        <h1 class="game-title">{{ game.icon }} {{ game.name }}</h1>
        <div class="game-timer" id="timer">60</div>
        
        <div class="game-progress">
            <div class="progress-stat">
                Question: <span id="current-question">1</span>/<span id="total-questions">{{ questions|length }}</span>
            </div>
            <div class="progress-stat">
                Score: <span id="score">0</span>
            </div>
            <div class="progress-stat">
                Correct: <span id="correct">0</span>
            </div>
        </div>
    </div>

    <div class="question-card" id="question-container">
        <!-- Questions will be loaded here by JavaScript -->
    </div>

    <button class="submit-btn" id="start-btn" onclick="startGame()">Start Game!</button>

</div>

<!-- Results Modal -->
<div class="results-modal" id="results-modal">
    <div class="results-content">
        <div class="results-title" id="results-title">üéâ Game Complete! üéâ</div>
        
        <div class="results-stats">
            <div class="result-stat">
                <div class="result-stat-label">Final Score</div>
                <div class="result-stat-value" id="final-score">0</div>
            </div>
            <div class="result-stat">
                <div class="result-stat-label">Accuracy</div>
                <div class="result-stat-value" id="final-accuracy">0%</div>
            </div>
            <div class="result-stat">
                <div class="result-stat-label">Time</div>
                <div class="result-stat-value" id="final-time">0s</div>
            </div>
            <div class="result-stat">
                <div class="result-stat-label">XP Earned</div>
                <div class="result-stat-value" id="xp-earned">+0</div>
            </div>
            <div class="result-stat">
                <div class="result-stat-label">Tokens</div>
                <div class="result-stat-value" id="tokens-earned" style="background: linear-gradient(135deg, #ffdd55, #ff9900); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">+0</div>
            </div>
        </div>

        <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <a href="/arcade/game/{{ game.game_key }}" class="submit-btn">üîÑ Play Again</a>
            <a href="/arcade" class="submit-btn" style="background: linear-gradient(135deg, #ff6fd8, #ffdd55);">üéÆ Arcade Hub</a>
            <a href="/dashboard" class="submit-btn" style="background: linear-gradient(135deg, #5c6bff, #00f2ff);">üè† Dashboard</a>
        </div>
    </div>
</div>

<script>
    const questions = {{ questions | tojson }};
    const gameKey = "{{ game.game_key }}";
    const characterName = "{{ character }}";
    let currentIndex = 0;
    let score = 0;
    let correct = 0;
    let timeLeft = 60;
    let timerInterval = null;
    let gameStartTime = null;
    let isAnswering = false; // Prevent multiple clicks

    function startGame() {
        document.getElementById('start-btn').style.display = 'none';
        gameStartTime = Date.now();
        showQuestion();
        startTimer();
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').textContent = timeLeft;
            
            if (timeLeft <= 10) {
                document.getElementById('timer').style.color = '#ff6b6b';
            }
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                endGame();
            }
        }, 1000);
    }

    function showQuestion() {
        try {
            if (currentIndex >= questions.length) {
                endGame();
                return;
            }

            isAnswering = false; // Reset for new question
            const question = questions[currentIndex];
            const container = document.getElementById('question-container');
            container.style.display = 'flex'; // Ensure container is visible
            document.getElementById('current-question').textContent = currentIndex + 1;

            if (!question) {
                container.innerHTML = `<div style='color:red;font-weight:bold;'>Error: Question data missing at index ${currentIndex}. Please report this bug.</div>`;
                return;
            }

            if (question.options) {
                // Multiple choice - check if it's a vocab question (has 'word' field)
                let questionText;
                if (question.word) {
                    questionText = `What does "${question.word}" mean?`;
                } else {
                    questionText = question.question;
                }
                container.innerHTML = `
                    <div class="question-text">${questionText}</div>
                    <div class="options-grid" id="options-grid">
                        ${question.options.map((opt, i) => `
                            <button class="option-btn" data-answer="${String(opt).replace(/"/g, '&quot;')}" onclick="checkAnswer(this.dataset.answer)">${opt}</button>
                        `).join('')}
                    </div>
                `;
            } else if (question.question) {
                // Text input
                container.innerHTML = `
                    <div class="question-text">${question.question}</div>
                    <input type="text" class="answer-input" id="answer-input" placeholder="Your answer" 
                           onkeypress="if(event.key === 'Enter') checkAnswer(document.getElementById('answer-input').value)">
                    <button class="submit-btn" onclick="checkAnswer(document.getElementById('answer-input').value)">Submit</button>
                `;
                setTimeout(() => document.getElementById('answer-input').focus(), 100);
            } else {
                container.innerHTML = `<div style='color:red;font-weight:bold;'>Error: Malformed question object at index ${currentIndex}. Please report this bug.</div>`;
            }
        } catch (err) {
            const container = document.getElementById('question-container');
            container.innerHTML = `<div style='color:red;font-weight:bold;'>Unexpected error: ${err.message}</div>`;
            console.error('Arcade question error:', err);
        }
    }

    function checkAnswer(userAnswer) {
        if (isAnswering) return; // Prevent double-clicking
        isAnswering = true;

        const question = questions[currentIndex];
        // Get correct answer - handle vocab questions with 'definition' field
        let correctAnswer;
        if (question.definition) {
            correctAnswer = question.definition.toString().toLowerCase().trim();
        } else if (question.answer) {
            correctAnswer = question.answer.toString().toLowerCase().trim();
        } else {
            correctAnswer = '';
        }

        // Robust normalization (match backend)
        function normalize(val) {
            if (!val) return '';
            let v = val.toString().toLowerCase().trim();
            v = v.replace(/(percent|%|\$|,)/g, '');
            v = v.replace(/\s+/g, '');
            return v;
        }
        let normUser = normalize(userAnswer);
        let normCorrect = normalize(correctAnswer);
        let isCorrect = false;
        // Try float comparison if both are numbers
        if (!isNaN(parseFloat(normUser)) && !isNaN(parseFloat(normCorrect))) {
            isCorrect = Math.abs(parseFloat(normUser) - parseFloat(normCorrect)) < 1e-6;
        } else {
            isCorrect = normUser === normCorrect;
        }
        // Debugging output
        console.log('User answer:', userAnswer, 'Normalized:', normUser, 'Correct:', correctAnswer, 'Normalized:', normCorrect, 'isCorrect:', isCorrect);

        // Visual feedback
        if (question.options) {
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(btn => {
                btn.disabled = true;
                if (btn.dataset.answer.toLowerCase().trim() === correctAnswer) {
                    btn.classList.add('correct');
                } else if (btn.dataset.answer === userAnswer && !isCorrect) {
                    btn.classList.add('incorrect');
                }
            });
        }

        if (isCorrect) {
            correct++;
            score += 100;
            document.getElementById('correct').textContent = correct;
            document.getElementById('score').textContent = score;
            // Launch confetti if available
            if (typeof CozmicEnhancements !== 'undefined' && CozmicEnhancements.launchConfetti) {
                CozmicEnhancements.launchConfetti(10);
            }
        }

        // Show loading spinner while waiting for next question
        const container = document.getElementById('question-container');
        container.innerHTML = `<div style='text-align:center;padding:40px;'><span class='loader'></span> Loading next question...</div>`;

        currentIndex++;
        // Move to next question after brief delay
        setTimeout(() => {
            // Force re-render in case of browser caching issues
            container.innerHTML = '';
            showQuestion();
        }, 800);
    }

    function endGame() {
        if (!gameStartTime) return; // Game hasn't started yet
        
        clearInterval(timerInterval);
        const totalTime = Math.floor((Date.now() - gameStartTime) / 1000);
        const accuracy = questions.length > 0 ? Math.round((correct / questions.length) * 100) : 0;

        // Hide question card
        document.getElementById('question-container').style.display = 'none';

        // Submit results to server
        fetch('/arcade/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                game_key: gameKey,
                score: score,
                correct: correct,
                total: questions.length,
                time_seconds: totalTime
            })
        })
        .then(response => response.json())
        .then(data => {
            showResults(score, accuracy, totalTime, data.xp_earned || 0, data.new_high_score, data.tokens_earned || 0);
        })
        .catch(error => {
            console.error('Error submitting results:', error);
            // Show results anyway even if submit fails
            showResults(score, accuracy, totalTime, 50, false, 1);
        });
    }

    function showResults(finalScore, accuracy, time, xp, isHighScore, tokens) {
        document.getElementById('final-score').textContent = finalScore;
        document.getElementById('final-accuracy').textContent = accuracy + '%';
        document.getElementById('final-time').textContent = time + 's';
        document.getElementById('xp-earned').textContent = '+' + xp;

        // Performance-based message
        let performanceMsg = '';
        let performanceColor = '';
        
        if (accuracy >= 90) {
            performanceMsg = 'üåü Outstanding! You\'re a genius!';
            performanceColor = '#00ff88';
        } else if (accuracy >= 75) {
            performanceMsg = 'üéâ Great job! Keep it up!';
            performanceColor = '#00f2ff';
        } else if (accuracy >= 50) {
            performanceMsg = 'üëç Good effort! Practice makes perfect!';
            performanceColor = '#ffdd55';
        } else {
            performanceMsg = 'üí™ Keep practicing! You\'ll get better!';
            performanceColor = '#ff6fd8';
        }

        // Add performance message to results
        const resultsTitle = document.getElementById('results-title');
        if (isHighScore) {
            resultsTitle.innerHTML = 'üèÜ NEW HIGH SCORE! üèÜ';
            if (typeof CozmicEnhancements !== 'undefined' && CozmicEnhancements.celebrationBurst) {
                CozmicEnhancements.celebrationBurst();
            }
        } else {
            resultsTitle.textContent = performanceMsg;
            resultsTitle.style.color = performanceColor;
            if (typeof CozmicEnhancements !== 'undefined' && CozmicEnhancements.launchConfetti) {
                CozmicEnhancements.launchConfetti(50);
            }
        }

        // Add tokens display
        document.getElementById('tokens-earned').textContent = '+' + tokens;

        document.getElementById('results-modal').classList.add('show');

        // Show character encouragement
        setTimeout(() => {
            if (typeof CozmicEnhancements !== 'undefined' && CozmicEnhancements.showCharacterComment) {
                CozmicEnhancements.showCharacterComment('encouragement', characterName);
            }
        }, 500);
    }
</script>

{% endblock %}
