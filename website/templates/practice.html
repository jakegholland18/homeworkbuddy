<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Practice Mode</title>

    <link rel="stylesheet" href="/static/style.css">

    <style>
        body {
            background: radial-gradient(circle at top, #0f1a2b, #000814);
            font-family: "Poppins", sans-serif;
            color: white;
            margin: 0;
            padding: 0;
        }

        .stars {
            position: fixed;
            inset: 0;
            background: url('/static/stars.png');
            background-size: cover;
            opacity: 0.28;
            z-index: -1;
            animation: drift 55s linear infinite;
        }

        @keyframes drift {
            from { transform: translateY(0); }
            to { transform: translateY(-1800px); }
        }

        .practice-container {
            width: 90%;
            max-width: 900px;
            margin: 60px auto;
            background: rgba(255,255,255,0.06);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 0 25px rgba(0,0,0,0.6);
            backdrop-filter: blur(6px);
        }

        /* Return button */
        .return-row {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 10px;
        }
        .return-btn {
            background: transparent;
            border: none;
            color: #bfe6ff;
            font-size: 0.95rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .return-btn:hover {
            text-decoration: underline;
        }

        .avatar {
            width: 160px;
            height: auto;
            display: block;
            margin: 0 auto 15px;
            transition: transform 0.3s ease;
        }

        .prompt-title {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        /* ---------- Animations ---------- */

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-6px); }
            50% { transform: translateX(6px); }
            75% { transform: translateX(-6px); }
            100% { transform: translateX(0); }
        }
        .shake { animation: shake 0.35s ease; }

        @keyframes glowHint {
            0% { text-shadow: 0 0 4px #ff4d4d; color: #ffb3b3; }
            100% { text-shadow: 0 0 14px #ff1a1a; color: #ffecec; }
        }
        .glow { animation: glowHint 0.9s ease-in-out; }

        @keyframes correctFlash {
            0% { background-color: rgba(0,255,120,0.15); }
            100% { background-color: transparent; }
        }
        .correct-flash { animation: correctFlash 0.7s ease; }

        /* -------------------------------- */

        .prompt-box {
            background: rgba(255,255,255,0.12);
            padding: 20px;
            border-radius: 15px;
            font-size: 1.2rem;
            margin-bottom: 20px;
            transition: background-color 0.3s ease;
        }

        /* Topic chooser */
        .topic-row {
            margin-bottom: 20px;
            text-align: center;
        }
        #topic-input {
            width: 70%;
            max-width: 450px;
            padding: 10px 14px;
            border-radius: 12px;
            border: none;
            outline: none;
            font-size: 1rem;
            margin-top: 8px;
        }
        #start-topic-btn {
            margin-top: 10px;
            padding: 10px 18px;
            border-radius: 10px;
            border: none;
            background: #1e88ff;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        #start-topic-btn:hover {
            background: #3ea0ff;
        }

        /* Input row */
        .input-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        #student-answer {
            flex-grow: 1;
            padding: 12px 15px;
            border-radius: 12px;
            border: none;
            outline: none;
            font-size: 1.05rem;
        }

        .submit-btn {
            background: #1e88ff;
            padding: 12px 20px;
            border-radius: 12px;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.05rem;
            transition: 0.25s;
        }

        .submit-btn:hover {
            background: #42a1ff;
        }

        /* Multiple choice options */
        #choices-container {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .choice-btn {
            text-align: left;
            padding: 10px 14px;
            border-radius: 10px;
            border: none;
            background: rgba(255,255,255,0.9);
            color: #222;
            cursor: pointer;
            font-size: 1rem;
        }
        .choice-btn:hover {
            background: #e0f0ff;
        }

        .status-message {
            margin-top: 20px;
            font-size: 1.1rem;
            text-align: center;
            min-height: 30px;
        }

        /* Loading / thinking */
        .thinking {
            font-size: 0.95rem;
            opacity: 0.85;
        }

        /* Session complete buttons */
        .session-actions {
            margin-top: 20px;
            text-align: center;
            display: none;
        }
        .session-actions button {
            margin: 5px;
            padding: 10px 18px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        .session-primary {
            background: #1e88ff;
            color: white;
        }
        .session-secondary {
            background: rgba(255,255,255,0.9);
            color: #111;
        }
    </style>
</head>

<body>

<div class="stars"></div>

<div class="practice-container">
    <div class="return-row">
        <button class="return-btn" onclick="window.history.back()">
            ‚¨ÖÔ∏è Return to previous screen
        </button>
    </div>

    <img id="character-avatar" class="avatar" src="/static/characters/{{ character }}.png">

    <h2 class="prompt-title">üöÄ Practice Mission</h2>

    <!-- TOPIC SELECTION -->
    <div id="topic-section" class="topic-row">
        <div>What topic would you like to practice?</div>
        <input id="topic-input" type="text"
               placeholder="e.g. percentages, fractions, decimals, reading, money...">
        <br>
        <button id="start-topic-btn">Start Practice</button>
    </div>

    <!-- QUESTION / PRACTICE SECTION -->
    <div id="practice-section" style="display:none;">
        <div id="practice-prompt" class="prompt-box">
            Loading your practice mission...
        </div>

        <!-- Multiple choice options (only visible when needed) -->
        <div id="choices-container" style="display:none;"></div>

        <!-- Free-response answer row -->
        <div class="input-row" id="free-response-row">
            <input id="student-answer" type="text" placeholder="Type your answer...">
            <button class="submit-btn" onclick="sendPracticeAnswer()">Submit</button>
        </div>

        <div id="status" class="status-message"></div>

        <!-- Session end actions -->
        <div id="session-actions" class="session-actions">
            <button class="session-primary" onclick="restartSameTopic()">üîÅ More questions on this topic</button>
            <button class="session-secondary" onclick="chooseNewTopic()">üîÑ Practice a different topic</button>
        </div>
    </div>

</div>

<script>
let currentType = "free";
let currentTopic = "";
let currentSubject = "{{ subject }}";

// Start when student chooses topic
document.getElementById("start-topic-btn").addEventListener("click", startPracticeFromTopic);

function startPracticeFromTopic() {
    const topicInput = document.getElementById("topic-input");
    const topic = topicInput.value.trim();
    if (!topic) return;

    currentTopic = topic;

    document.getElementById("topic-section").style.display = "none";
    document.getElementById("practice-section").style.display = "block";

    startPractice();
}

function restartSameTopic() {
    document.getElementById("session-actions").style.display = "none";
    startPractice();
}

function chooseNewTopic() {
    document.getElementById("practice-section").style.display = "none";
    document.getElementById("topic-section").style.display = "block";
    document.getElementById("status").innerHTML = "";
    document.getElementById("session-actions").style.display = "none";
    document.getElementById("topic-input").value = "";
}

// INITIAL CALL TO SERVER FOR FIRST QUESTION
function startPractice() {
    const promptBox = document.getElementById("practice-prompt");
    const status = document.getElementById("status");
    const choicesDiv = document.getElementById("choices-container");
    const freeRow = document.getElementById("free-response-row");

    status.innerHTML = "<span class='thinking'>ü§ñ Preparing your first mission‚Ä¶</span>";
    choicesDiv.style.display = "none";
    choicesDiv.innerHTML = "";
    freeRow.style.display = "flex";

    fetch("/start_practice", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            topic: currentTopic,
            subject: currentSubject
        })
    })
    .then(res => res.json())
    .then(data => {
        status.innerHTML = "";
        promptBox.innerText = data.prompt || "Ready!";
        document.getElementById("character-avatar").src =
            "/static/characters/" + (data.character || "{{ character }}") + ".png";

        setQuestionType(data);
    });
}

// Decide whether question is multiple choice or free response
function setQuestionType(data) {
    const choicesDiv = document.getElementById("choices-container");
    const freeRow = document.getElementById("free-response-row");
    const answerBox = document.getElementById("student-answer");

    currentType = data.type || "free";

    if (currentType === "multiple_choice" && data.choices && data.choices.length) {
        choicesDiv.innerHTML = "";
        data.choices.forEach(choice => {
            const btn = document.createElement("button");
            btn.className = "choice-btn";
            btn.textContent = choice;
            btn.onclick = () => sendPracticeAnswer(choice);
            choicesDiv.appendChild(btn);
        });
        choicesDiv.style.display = "flex";
        freeRow.style.display = "none";
    } else {
        choicesDiv.style.display = "none";
        freeRow.style.display = "flex";
        answerBox.value = "";
        answerBox.focus();
    }
}

// ENTER KEY SUBMITS ANSWER (for free-response)
document.addEventListener("keydown", function (e) {
    const freeRowVisible = document.getElementById("free-response-row").style.display !== "none";
    if (e.key === "Enter" && freeRowVisible) {
        e.preventDefault();
        sendPracticeAnswer();
    }
});

async function sendPracticeAnswer(chosenValue=null) {
    const answerBox = document.getElementById("student-answer");
    const promptBox = document.getElementById("practice-prompt");
    const status = document.getElementById("status");
    const avatar = document.getElementById("character-avatar");
    const actions = document.getElementById("session-actions");

    const userAnswer = (chosenValue !== null ? chosenValue : answerBox.value).trim();
    if (!userAnswer) return;

    status.innerHTML = "<span class='thinking'>ü§ñ Thinking with you‚Ä¶</span>";

    const res = await fetch("/practice_step", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ answer: userAnswer })
    });

    const data = await res.json();

    // -------- CORRECT --------
    if (data.status === "correct") {
        status.innerHTML = "‚úÖ Correct!";
        promptBox.innerText = data.next_prompt;

        promptBox.classList.add("correct-flash");
        setTimeout(() => promptBox.classList.remove("correct-flash"), 700);

        setQuestionType(data);
    }
    // -------- INCORRECT (with hint) --------
    else if (data.status === "incorrect") {
        status.innerHTML = "‚ùå Try again! Hint: " + (data.hint || "Think about each step carefully.");

        answerBox.classList.add("shake");
        status.classList.add("glow");

        setTimeout(() => answerBox.classList.remove("shake"), 350);
        setTimeout(() => status.classList.remove("glow"), 900);
    }
    // -------- GUIDED / EXPLANATION AFTER 2 FAILS --------
    else if (data.status === "guided") {
        status.innerHTML = "üß† Let's walk through it together:<br>" + (data.explanation || "");
        if (data.next_prompt) {
            promptBox.innerText = data.next_prompt;
            setQuestionType(data);
        } else {
            // Session might be over
            promptBox.innerText = "Mission complete for this question!";
        }
    }
    // -------- FINISHED SESSION --------
    else if (data.status === "finished") {
        status.innerHTML = "üåü " + (data.message || "Awesome work! You finished this practice mission.");
        promptBox.innerText = "Mission Complete!";
        actions.style.display = "block";
    }

    if (data.character) {
        avatar.src = "/static/characters/" + data.character + ".png";
    }
}
</script>

</body>
</html>

