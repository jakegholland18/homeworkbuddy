<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Practice Mode</title>

    <link rel="stylesheet" href="/static/style.css?v=20251202">
    <script src="/static/enhancements.js?v=20251202" defer></script>

    <style>
        body {
            background: var(--bg-gradient-main);
            font-family: "Poppins", sans-serif;
            color: white;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .practice-wrapper {
            width: 94%;
            max-width: 1200px;
            margin: 40px auto 80px;
            background: linear-gradient(135deg,
                rgba(192, 132, 252, 0.1),
                rgba(255, 111, 216, 0.06)
            );
            border: 1.5px solid rgba(255, 111, 216, 0.3);
            padding: 28px;
            border-radius: 24px;
            box-shadow: 
                0 16px 50px rgba(0, 0, 0, 0.4),
                0 0 32px rgba(255, 111, 216, 0.18),
                inset 1px 1px 0 rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(14px);
        }

        /* Return button */
        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .return-btn {
            background: none;
            border: none;
            color: #84ff00;
            font-size: 0.95rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .return-btn:hover {
            color: #ffdd55;
            transform: translateX(-3px);
        }

        .question-counter {
            font-size: 0.95rem;
            color: #e0d9ff;
            font-weight: 600;
            background: linear-gradient(135deg, rgba(255, 111, 216, 0.2), rgba(192, 132, 252, 0.15));
            padding: 8px 14px;
            border-radius: 20px;
            border: 1px solid rgba(255, 111, 216, 0.3);
        }

        /* Progress bar */
        .progress-row { margin-top: 6px; }
        .progress-track {
            width: 100%;
            height: 8px;
            border-radius: 10px;
            background: rgba(192, 132, 252, 0.15);
            border: 1px solid rgba(255, 111, 216, 0.25);
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff6fd8, #c084fc, #84ff00);
            transition: width 0.35s ease;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr; /* stack for better alignment */
            gap: 24px;
            margin-top: 12px;
        }

        @media (max-width: 960px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        .avatar {
            width: 150px;
            height: auto;
            display: block;
            margin: 0 auto 10px;
            filter: drop-shadow(0 8px 20px rgba(92, 107, 255, 0.4));
        }

        .prompt-title {
            text-align: center;
            font-size: 1.6rem;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #00f2ff, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        /* ---------- Animations ---------- */

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-6px); }
            50% { transform: translateX(6px); }
            75% { transform: translateX(-6px); }
            100% { transform: translateX(0); }
        }
        .shake { animation: shake 0.35s ease; }

        @keyframes glowHint {
            0% { text-shadow: 0 0 4px #ff4d4d; color: #ffb3b3; }
            100% { text-shadow: 0 0 14px #ff1a1a; color: #ffecec; }
        }
        .glow { animation: glowHint 0.9s ease-in-out; }

        @keyframes correctFlash {
            0% { background-color: rgba(76, 175, 80, 0.25); }
            100% { background-color: transparent; }
        }
        .correct-flash { animation: correctFlash 0.7s ease; }

        /* -------------------------------- */

        .prompt-box {
            background: linear-gradient(135deg,
                rgba(192, 132, 252, 0.15),
                rgba(255, 111, 216, 0.08)
            );
            padding: 22px;
            border-radius: 18px;
            border: 2px solid rgba(255, 111, 216, 0.35);
            font-size: 1.15rem;
            margin-bottom: 14px;
            transition: all 0.3s ease;
            color: #f7fbff;
            line-height: 1.8;
            box-shadow: 
                0 8px 24px rgba(0, 0, 0, 0.3),
                0 0 20px rgba(255, 111, 216, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
        }

        .prompt-box:hover {
            box-shadow: 
                0 12px 32px rgba(0, 0, 0, 0.4),
                0 0 28px rgba(255, 111, 216, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        .last-answer {
            font-size: 0.95rem;
            color: #e0ff80;
            margin: 10px 0 8px;
            opacity: 0.95;
            padding: 12px 14px;
            background: linear-gradient(135deg, rgba(132, 255, 0, 0.15), rgba(84, 255, 0, 0.08));
            border-radius: 12px;
            border-left: 4px solid #84ff00;
            line-height: 1.6;
            box-shadow: 0 4px 12px rgba(132, 255, 0, 0.15);
        }

        /* Topic chooser */
        .topic-row {
            margin-bottom: 18px;
            text-align: center;
        }
        #topic-input {
            width: 70%;
            max-width: 450px;
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid rgba(118, 131, 255, 0.3);
            outline: none;
            font-size: 1rem;
            margin-top: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #f7fbff;
        }
        #topic-input::placeholder {
            color: #8a92b3;
        }
        #start-topic-btn {
            margin-top: 10px;
            padding: 10px 18px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #ffdd55, #ff9500);
            color: #1b0500;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 8px 24px rgba(255, 157, 84, 0.4);
        }
        #start-topic-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(255, 157, 84, 0.6);
        }

        /* Input row */
        .input-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        #student-answer {
            flex-grow: 1;
            padding: 13px 16px;
            border-radius: 14px;
            border: 2px solid rgba(255, 111, 216, 0.3);
            outline: none;
            font-size: 1.05rem;
            background: rgba(0, 0, 0, 0.3);
            color: #f7fbff;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(8px);
        }
        #student-answer:focus {
            border-color: #ff6fd8;
            box-shadow: 0 0 20px rgba(255, 111, 216, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.4);
        }
        #student-answer::placeholder {
            color: #b8a5d0;
        }

        .submit-btn {
            background: linear-gradient(135deg, #84ff00, #4caf50);
            padding: 12px 20px;
            border-radius: 12px;
            border: none;
            color: #0b0f1a;
            cursor: pointer;
            font-size: 1.05rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 8px 24px rgba(132, 255, 0, 0.4);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(132, 255, 0, 0.6);
        }

        /* Multiple choice options */
        #choices-container {
            margin-top: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .choice-btn {
            text-align: left;
            padding: 14px 16px;
            border-radius: 14px;
            border: 2px solid rgba(255, 111, 216, 0.3);
            background: linear-gradient(135deg, rgba(255, 111, 216, 0.12), rgba(192, 132, 252, 0.08));
            color: #f7fbff;
            cursor: pointer;
            font-size: 1.02rem;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .choice-btn::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, #ff6fd8, #c084fc);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .choice-btn:hover {
            background: linear-gradient(135deg, rgba(255, 111, 216, 0.25), rgba(192, 132, 252, 0.18));
            border-color: rgba(255, 111, 216, 0.7);
            transform: translateX(6px);
            box-shadow: 0 8px 20px rgba(255, 111, 216, 0.25);
        }

        .choice-btn:hover::before {
            opacity: 1;
        }

        .choice-btn.selected {
            background: linear-gradient(135deg, rgba(132, 255, 0, 0.25), rgba(84, 255, 0, 0.15));
            border-color: #84ff00;
            box-shadow: 0 0 20px rgba(132, 255, 0, 0.3);
        }

        .choice-btn.selected::before {
            background: #84ff00;
            opacity: 1;
        }

        .status-message {
            margin-top: 14px;
            font-size: 1.05rem;
            min-height: 28px;
            color: #e0d9ff;
            line-height: 1.6;
            padding: 10px;
            border-radius: 10px;
            background: rgba(192, 132, 252, 0.1);
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }

        .status-message.success {
            color: #84ff00;
            background: rgba(132, 255, 0, 0.12);
            border-left-color: #84ff00;
            box-shadow: 0 0 15px rgba(132, 255, 0, 0.2);
        }

        .status-message.error {
            color: #ff8787;
            background: rgba(255, 107, 107, 0.12);
            border-left-color: #ff6b6b;
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.2);
        }

        .status-message.info {
            color: #00f2ff;
            background: rgba(0, 242, 255, 0.08);
            border-left-color: #00f2ff;
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.15);
        }

        .thinking {
            font-size: 0.95rem;
            opacity: 0.85;
        }

        /* Navigation buttons */
        .nav-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 18px;
            gap: 10px;
        }
        .nav-group {
            display: flex;
            gap: 8px;
        }
        .nav-btn {
            padding: 8px 13px;
            border-radius: 10px;
            border: 1px solid rgba(118, 131, 255, 0.3);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .nav-btn-primary {
            background: linear-gradient(135deg, #ff6fd8, #c084fc);
            color: white;
            border: none;
        }
        .nav-btn-secondary {
            background: rgba(192, 132, 252, 0.2);
            color: #ff6fd8;
        }
        .nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        .nav-btn:disabled {
            opacity: 0.4;
            cursor: default;
        }

        /* Session complete */
        .session-actions {
            margin-top: 16px;
            text-align: center;
            display: none;
            gap: 10px;
        }
        .session-actions button {
            margin: 5px;
            padding: 10px 18px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .session-primary {
            background: linear-gradient(135deg, #84ff00, #4caf50);
            color: #0b0f1a;
            box-shadow: 0 8px 24px rgba(132, 255, 0, 0.4);
        }
        .session-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(132, 255, 0, 0.6);
        }
        .session-secondary {
            background: rgba(255, 111, 216, 0.2);
            color: #ff6fd8;
            border: 1px solid rgba(255, 111, 216, 0.3);
        }
        .session-secondary:hover {
            background: rgba(255, 111, 216, 0.3);
            border-color: rgba(255, 111, 216, 0.6);
        }

        /* HELP CHAT PANEL */
        .help-panel {
            background: linear-gradient(135deg,
                rgba(192, 132, 252, 0.15),
                rgba(255, 111, 216, 0.08)
            );
            border-radius: 20px;
            padding: 20px;
            border: 2px solid rgba(255, 111, 216, 0.4);
            box-shadow: 
                0 16px 50px rgba(0, 0, 0, 0.4),
                0 0 30px rgba(255, 111, 216, 0.3),
                inset 1px 1px 0 rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(16px);
            position: relative;
            overflow: hidden;
        }

        .help-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #ff6fd8, #c084fc, transparent);
            opacity: 0.8;
        }

        .help-title {
            font-size: 1.2rem;
            margin-bottom: 8px;
            color: #f7fbff;
            font-weight: 800;
            background: linear-gradient(135deg, #ff6fd8, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-subtitle {
            font-size: 0.9rem;
            color: #e0d9ff;
            opacity: 0.95;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .help-subtitle span {
            color: #ff6fd8;
            font-weight: 600;
        }

        .help-chat-log {
            max-height: 320px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 14px;
            padding: 12px;
            font-size: 0.95rem;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 111, 216, 0.3);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* Scrollbar styling */
        .help-chat-log::-webkit-scrollbar {
            width: 6px;
        }
        .help-chat-log::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        .help-chat-log::-webkit-scrollbar-thumb {
            background: rgba(255, 111, 216, 0.5);
            border-radius: 10px;
        }
        .help-chat-log::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 111, 216, 0.7);
        }

        .help-msg {
            margin-bottom: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            line-height: 1.5;
            animation: slideInMessage 0.3s ease;
        }

        @keyframes slideInMessage {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .help-msg-student {
            text-align: right;
            background: linear-gradient(135deg, rgba(132, 255, 0, 0.25), rgba(84, 255, 0, 0.15));
            color: #e0ff80;
            border-left: 3px solid transparent;
            border-right: 3px solid rgba(132, 255, 0, 0.6);
            margin-left: 30px;
        }

        .help-msg-tutor {
            text-align: left;
            background: linear-gradient(135deg, rgba(255, 111, 216, 0.2), rgba(192, 132, 252, 0.15));
            color: #f0d9ff;
            border-left: 3px solid rgba(255, 111, 216, 0.6);
            border-right: 3px solid transparent;
            margin-right: 30px;
        }

        .help-input-row {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        #help-msg-input {
            flex: 1;
            padding: 11px 14px;
            border-radius: 12px;
            border: 2px solid rgba(255, 111, 216, 0.4);
            outline: none;
            font-size: 0.95rem;
            background: rgba(0, 0, 0, 0.3);
            color: #f7fbff;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(8px);
        }

        #help-msg-input:focus {
            border-color: rgba(255, 111, 216, 0.8);
            box-shadow: 0 0 16px rgba(255, 111, 216, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.4);
        }

        #help-msg-input::placeholder {
            color: #b8a5d0;
        }

        .help-send-btn {
            padding: 11px 18px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #ff6fd8, #c084fc);
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 8px 20px rgba(255, 111, 216, 0.4);
            white-space: nowrap;
        }

        .help-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(255, 111, 216, 0.6);
        }

        .help-send-btn:active {
            transform: translateY(0);
        }

        #help-thinking {
            font-size: 0.85rem;
            color: #c084fc;
            margin-top: 6px;
            display: none;
            animation: pulse 1.5s ease-in-out infinite;
            font-weight: 500;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        /* Legal footer */
        .legal-footer {
            text-align: center;
            margin-top: 20px;
            opacity: 0.7;
            font-size: 0.9rem;
            color: #8a92b3;
        }
        .legal-footer a {
            color: #84ff00;
            margin: 0 10px;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        .legal-footer a:hover {
            color: #ffdd55;
            text-decoration: underline;
        }
    </style>
</head>

<body>
<div class="stars"></div>

<div class="practice-wrapper">

    <!-- Top Utility Bar for consistency -->
    <div class="utility-bar" role="navigation" aria-label="Quick actions" style="margin-bottom:12px;">
        <div class="utility-item">
            <label>ü™ê Subject</label>
            <select id="subject-switcher" class="utility-select">
                {% for key, val in subjects.items() %}
                    <option value="{{ key }}" {% if key == subject %}selected{% endif %}>{{ val }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="utility-item">
            <label>üî≠ Search topics or questions</label>
            <input id="global-search" class="utility-input" type="text" placeholder="e.g., percentages, thesis statement, photosynthesis...">
        </div>
        <div class="utility-actions">
            <button id="go-ask" class="utility-btn">üîé Ask Question</button>
            <button id="go-study" class="utility-btn">üìö Deep Study</button>
            <a href="/logout" class="utility-btn utility-logout" aria-label="Logout">üë©‚ÄçüöÄ Logout</a>
        </div>
    </div>

    <div class="top-row">
        <button class="return-btn" type="button" onclick="goBackToQuestionScreen()">
            ‚¨ÖÔ∏è Return to previous screen
        </button>
        <div class="question-counter" id="question-counter" style="display:none;">
            Question <span id="question-index">1</span> of <span id="question-total">10</span>
        </div>
    </div>

    <div class="main-layout">

        <!-- Practice Flow + Help aligned in one column -->
        <div>
            <img id="character-avatar" class="avatar" src="/static/characters/{{ character }}.png">

            <h2 class="prompt-title">üöÄ Practice Mission</h2>
            <div id="topic-recap" style="text-align:center; color:#c4d1ff; font-size:0.95rem; margin-bottom:8px; display:none;"></div>

            <!-- TOPIC SELECTION -->
            <div id="topic-section" class="topic-row">
                <div>What topic would you like to practice?</div>
                <input id="topic-input" type="text"
                       placeholder="e.g. percentages, fractions, reading, decimals, money...">
                <br>
                <button id="start-topic-btn">Start Practice</button>
            </div>

            <!-- QUESTION / PRACTICE SECTION -->
            <div id="practice-section" style="display:none;">
                <div id="practice-prompt" class="prompt-box">
                    Loading your practice mission...
                </div>

                <div class="progress-row">
                    <div class="progress-track"><div id="progress-fill" class="progress-fill"></div></div>
                </div>

                <div id="last-answer" class="last-answer" style="display:none;"></div>

                <!-- Multiple choice options (only visible when needed) -->
                <div id="choices-container" style="display:none;"></div>

                <!-- Free-response answer row -->
                <div class="input-row" id="free-response-row">
                    <input id="student-answer" type="text" placeholder="Type your answer...">
                    <button class="submit-btn" onclick="sendPracticeAnswer()">Submit</button>
                </div>

                <div id="status" class="status-message"></div>

                <!-- Nav + session controls -->
                <div class="nav-row">
                    <div class="nav-group">
                        <button id="prev-btn" class="nav-btn nav-btn-secondary" onclick="goPrevious()" disabled>
                            ‚¨ÖÔ∏è Previous
                        </button>
                        <button id="next-btn" class="nav-btn nav-btn-secondary" onclick="goNext()" disabled>
                            Next ‚û°Ô∏è
                        </button>
                    </div>
                    <div id="mini-status" style="font-size:0.85rem; color:#d0e4ff;"></div>
                </div>

                <!-- Session end actions -->
                <div id="session-actions" class="session-actions">
                    <button class="session-primary" onclick="restartSameTopic()">üîÅ More questions on this topic</button>
                    <button class="session-secondary" onclick="chooseNewTopic()">üîÑ Practice a different topic</button>
                </div>
            </div>

            <!-- HELP CHAT: moved under practice for better alignment -->
            <div class="help-panel">
                <div class="help-title">üß† Need help? Ask your tutor</div>
                <div class="help-subtitle">
                    Chat about <span id="help-question-label">this question</span>.  
                    Each question has its own mini chat.
                </div>

                <div id="help-chat-log" class="help-chat-log">
                    <!-- messages injected here -->
                </div>

                <div class="help-input-row">
                    <input id="help-msg-input" type="text" placeholder="Ask about this question...">
                    <button class="help-send-btn" onclick="sendHelpMessage()">Send</button>
                </div>
                <div id="help-thinking">ü§ñ Your tutor is thinking with you‚Ä¶</div>
            </div>
        </div>
    </div>

    <!-- LEGAL FOOTER -->
    <div class="legal-footer">
        <a href="/terms">Terms</a> |
        <a href="/privacy">Privacy Policy</a> |
        <a href="/disclaimer">Disclaimer</a>
        <div style="margin-top:8px; font-size:0.8rem;">
            Homework Buddy is an educational tool.<br>
            While Homework Buddy is out of this world, please check important information for accuracy.
        </div>
    </div>
</div>

<script>
let currentType = "free";
let currentTopic = "";
let currentSubject = "{{ subject }}";
let currentIndex = 0;
let totalQuestions = 0;

// START: Return button (no form resubmission)
function goBackToQuestionScreen() {
    const subject = "{{ subject }}";
    const grade = "{{ grade }}";
    window.location.href = "/ask-question?subject="
        + encodeURIComponent(subject)
        + "&grade="
        + encodeURIComponent(grade);
}

// Start when student chooses topic
document.getElementById("start-topic-btn").addEventListener("click", startPracticeFromTopic);

function startPracticeFromTopic() {
    const topicInput = document.getElementById("topic-input");
    const topic = topicInput.value.trim();
    if (!topic) return;

    currentTopic = topic;

    const recap = document.getElementById("topic-recap");
    recap.style.display = "block";
    recap.innerText = "Practicing topic: " + topic;

    document.getElementById("topic-section").style.display = "none";
    document.getElementById("practice-section").style.display = "block";

    startPractice();
}

function restartSameTopic() {
    document.getElementById("session-actions").style.display = "none";
    startPractice();
}

function chooseNewTopic() {
    document.getElementById("practice-section").style.display = "none";
    document.getElementById("topic-section").style.display = "block";
    document.getElementById("status").innerHTML = "";
    document.getElementById("session-actions").style.display = "none";
    document.getElementById("topic-input").value = "";
    document.getElementById("question-counter").style.display = "none";
    document.getElementById("help-chat-log").innerHTML = "";
}

// INITIAL CALL TO SERVER FOR FIRST QUESTION
function startPractice() {
    const promptBox = document.getElementById("practice-prompt");
    const status = document.getElementById("status");
    const choicesDiv = document.getElementById("choices-container");
    const freeRow = document.getElementById("free-response-row");
    const lastAnswerBox = document.getElementById("last-answer");

    status.innerHTML = "<span class='thinking'>ü§ñ Preparing your first mission‚Ä¶</span>";
    choicesDiv.style.display = "none";
    choicesDiv.innerHTML = "";
    freeRow.style.display = "flex";
    lastAnswerBox.style.display = "none";
    lastAnswerBox.innerText = "";

    fetch("/start_practice", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            topic: currentTopic,
            subject: currentSubject
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "error") {
            status.innerHTML = data.message || "Something went wrong starting practice.";
            return;
        }

        status.innerHTML = "";
        totalQuestions = data.total || 1;
        currentIndex = data.index || 0;

        document.getElementById("question-counter").style.display = "block";
        document.getElementById("question-index").innerText = currentIndex + 1;
        document.getElementById("question-total").innerText = totalQuestions;

        updateProgressBar();

        promptBox.innerText = data.prompt || "Ready!";
        document.getElementById("character-avatar").src =
            "/static/characters/" + (data.character || "{{ character }}") + ".png";

        updateNavButtons();
        setQuestionType(data);
        renderLastAnswer(data.last_answer || "");
        renderHelpChat(data.chat || []);
    });
}

function updateNavButtons() {
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");

    prevBtn.disabled = currentIndex <= 0;
    nextBtn.disabled = currentIndex >= totalQuestions - 1;

    document.getElementById("question-index").innerText = currentIndex + 1;
    document.getElementById("question-total").innerText = totalQuestions;

    updateProgressBar();
}

function updateProgressBar() {
    const fill = document.getElementById("progress-fill");
    const percent = totalQuestions > 0 ? Math.min(100, Math.max(0, Math.round(((currentIndex + 1) / totalQuestions) * 100))) : 0;
    fill.style.width = percent + "%";
}

// Decide whether question is multiple choice or free response
function setQuestionType(data) {
    const choicesDiv = document.getElementById("choices-container");
    const freeRow = document.getElementById("free-response-row");
    const answerBox = document.getElementById("student-answer");

    currentType = data.type || "free";

    if (currentType === "multiple_choice" && data.choices && data.choices.length) {
        choicesDiv.innerHTML = "";
        data.choices.forEach((choice, idx) => {
            const btn = document.createElement("button");
            btn.className = "choice-btn";
            btn.textContent = choice;
            const letter = String.fromCharCode(97 + idx); // a, b, c, d
            btn.dataset.letter = letter;
            btn.onclick = () => sendPracticeAnswer(letter);
            choicesDiv.appendChild(btn);
        });
        choicesDiv.style.display = "flex";
        freeRow.style.display = "none";
    } else {
        choicesDiv.style.display = "none";
        freeRow.style.display = "flex";
        if (data.last_answer) {
            answerBox.value = data.last_answer;
        } else {
            answerBox.value = "";
        }
        answerBox.focus();
    }
}

function renderLastAnswer(ans) {
    const box = document.getElementById("last-answer");
    if (ans && ans.trim() !== "") {
        box.style.display = "block";
        box.innerText = "Your last answer: " + ans;
    } else {
        box.style.display = "none";
        box.innerText = "";
    }
}

function renderHelpChat(chatArray) {
    const log = document.getElementById("help-chat-log");
    log.innerHTML = "";
    (chatArray || []).forEach(msg => {
        const div = document.createElement("div");
        div.classList.add("help-msg");
        if (msg.role === "student") {
            div.classList.add("help-msg-student");
        } else {
            div.classList.add("help-msg-tutor");
        }
        div.textContent = msg.content;
        log.appendChild(div);
    });
    log.scrollTop = log.scrollHeight;
}

// ENTER KEY SUBMITS ANSWER (for free-response)
document.addEventListener("keydown", function (e) {
    const freeRowVisible = document.getElementById("free-response-row").style.display !== "none";
    const helpInput = document.getElementById("help-msg-input");
    if (document.activeElement === helpInput) return;

    if (e.key === "Enter" && freeRowVisible) {
        e.preventDefault();
        sendPracticeAnswer();
    }
});

async function sendPracticeAnswer(chosenValue=null) {
    const answerBox = document.getElementById("student-answer");
    const promptBox = document.getElementById("practice-prompt");
    const status = document.getElementById("status");
    const actions = document.getElementById("session-actions");
    const avatar = document.getElementById("character-avatar");

    const raw = (chosenValue !== null ? chosenValue : answerBox.value);
    const userAnswer = raw.trim();
    if (!userAnswer) return;

    status.innerHTML = "<span class='thinking'>ü§ñ Thinking with you‚Ä¶</span>";
    document.getElementById("mini-status").innerText = "";

    const res = await fetch("/practice_step", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ answer: userAnswer })
    });

    const data = await res.json();

    // -------- CORRECT --------
    if (data.status === "correct") {
        status.innerHTML = "‚úÖ Nice! That's correct.";
        promptBox.innerText = data.next_prompt || promptBox.innerText;

        promptBox.classList.add("correct-flash");
        setTimeout(() => promptBox.classList.remove("correct-flash"), 700);

        renderLastAnswer(userAnswer);
        setQuestionType(data);
        document.getElementById("mini-status").innerText = "This question is marked correct.";
    }
    // -------- INCORRECT (with hint) --------
    else if (data.status === "incorrect") {
        status.innerHTML = "‚ùå Try again! Hint: " + (data.hint || "Think about each step carefully.");

        answerBox.classList.add("shake");
        status.classList.add("glow");

        setTimeout(() => answerBox.classList.remove("shake"), 350);
        setTimeout(() => status.classList.remove("glow"), 900);
    }
    // -------- GUIDED / EXPLANATION AFTER 2 FAILS --------
    else if (data.status === "guided") {
        status.innerHTML = "üß† Let's walk through it together:<br>" + (data.explanation || "");
        if (data.next_prompt) {
            promptBox.innerText = data.next_prompt;
            setQuestionType(data);
        }
        renderLastAnswer(userAnswer);
        document.getElementById("mini-status").innerText = "We walked through this one together.";
    }
    // -------- FINISHED SESSION --------
    else if (data.status === "finished") {
        status.innerHTML = "üåü " + (data.message || "Awesome work! You finished this practice mission.");
        promptBox.innerText = "Mission Complete!";
        actions.style.display = "block";
        if (data.explanation) {
            status.innerHTML += "<br><br><strong>Final Explanation:</strong> " + data.explanation;
        }
    }

    if (data.character) {
        avatar.src = "/static/characters/" + data.character + ".png";
    }
}

// Navigation
function goPrevious() {
    if (currentIndex <= 0) return;
    navigateToQuestion(currentIndex - 1);
}

function goNext() {
    if (currentIndex >= totalQuestions - 1) return;
    navigateToQuestion(currentIndex + 1);
}

function navigateToQuestion(index) {
    const status = document.getElementById("status");
    const promptBox = document.getElementById("practice-prompt");

    status.innerHTML = "<span class='thinking'>üîÅ Loading that question‚Ä¶</span>";

    fetch("/navigate_question", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ index: index })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "error") {
            status.innerHTML = data.message || "Issue loading this question.";
            return;
        }

        currentIndex = data.index || 0;
        totalQuestions = data.total || totalQuestions || 1;

        promptBox.innerText = data.prompt || "";
        document.getElementById("character-avatar").src =
            "/static/characters/" + (data.character || "{{ character }}") + ".png";

        updateNavButtons();
        renderLastAnswer(data.last_answer || "");
        setQuestionType(data);
        renderHelpChat(data.chat || []);

        document.getElementById("mini-status").innerText =
            data.question_status === "correct"
                ? "This question is marked correct."
                : (data.question_status === "given_up"
                    ? "We walked through this one together."
                    : "");
        status.innerHTML = "";
        updateProgressBar();
    });
}

// HELP CHAT
async function sendHelpMessage() {
    const input = document.getElementById("help-msg-input");
    const text = input.value.trim();
    if (!text) return;

    const log = document.getElementById("help-chat-log");
    const thinking = document.getElementById("help-thinking");

    // Add student message locally
    const studentDiv = document.createElement("div");
    studentDiv.classList.add("help-msg", "help-msg-student");
    studentDiv.textContent = text;
    log.appendChild(studentDiv);
    log.scrollTop = log.scrollHeight;

    input.value = "";
    thinking.style.display = "block";

    const res = await fetch("/practice_help_message", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ message: text })
    });

    thinking.style.display = "none";

    const data = await res.json();
    const reply = data.reply || "I'm here with you! Try rephrasing what you need help with.";

    const tutorDiv = document.createElement("div");
    tutorDiv.classList.add("help-msg", "help-msg-tutor");
    tutorDiv.textContent = reply;
    log.appendChild(tutorDiv);
    log.scrollTop = log.scrollHeight;
}

// ENTER submits in help chat when focused
document.getElementById("help-msg-input").addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
        e.preventDefault();
        sendHelpMessage();
    }
});
</script>

<script>
// Utility bar behavior
document.addEventListener("DOMContentLoaded", () => {
    const subjectSel = document.getElementById("subject-switcher");
    const searchInput = document.getElementById("global-search");
    const grade = "{{ grade }}";

    subjectSel?.addEventListener("change", () => {
        const subj = subjectSel.value;
        window.location.href = "/ask-question?subject=" + encodeURIComponent(subj) + "&grade=" + encodeURIComponent(grade);
    });

    searchInput?.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && searchInput.value.trim()) {
            const subj = subjectSel?.value || "{{ subject }}";
            const q = searchInput.value.trim();
            window.location.href = "/ask-question?subject=" + encodeURIComponent(subj) + "&grade=" + encodeURIComponent(grade) + "&q=" + encodeURIComponent(q);
        }
    });

    document.getElementById("go-ask")?.addEventListener("click", () => {
        const subj = subjectSel?.value || "{{ subject }}";
        window.location.href = "/ask-question?subject=" + encodeURIComponent(subj) + "&grade=" + encodeURIComponent(grade);
    });

    document.getElementById("go-study")?.addEventListener("click", () => {
        window.location.href = "/ask-question?subject=power_grid&grade=" + encodeURIComponent(grade);
    });
});
</script>

</body>
</html>




